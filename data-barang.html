<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Barang - GrowInd</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Top Header -->
    <nav class="navbar navbar-expand-lg fixed-top" style="background-color: #fbbf24; height: 60px;">
        <div class="container-fluid">
            <button class="btn btn-outline-dark me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <span class="navbar-brand mb-0 h1 text-dark fw-bold">GrowInd</span>
            <div class="ms-auto">
                <span class="text-dark me-3 d-flex align-items-center">
                    <!-- Profile picture in navbar - will be updated from localStorage -->
                    <img src="https://via.placeholder.com/32" class="rounded-circle me-2" alt="Profile" id="navbarProfilePicture" style="width: 32px; height: 32px; object-fit: cover;">
                    <!-- User name in navbar - will be updated from localStorage -->
                    <span id="currentUser">admin</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="offcanvas offcanvas-start sidebar-dark" tabindex="-1" id="sidebar">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title text-white">GrowInd</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="data-barang.html">
                        <i class="fas fa-boxes"></i> Data Barang
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="toggleSubmenu(event)">
                        <i class="fas fa-cog"></i> Kelola Barang
                        <i class="fas fa-chevron-down float-end mt-1"></i>
                    </a>
                    <ul class="submenu" style="display: none;">
                        <li><a class="nav-link ps-4" href="barang-masuk.html">Barang Masuk</a></li>
                        <li><a class="nav-link ps-4" href="barang-keluar.html">Barang Keluar</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="kelola-toko.html">
                        <i class="fas fa-store"></i> Kelola Toko
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="profile.html">
                        <i class="fas fa-user"></i> Profil
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <div id="successAlert" class="alert alert-success alert-dismissible fade show" style="display: none;">
                <strong>Berhasil!</strong> <span id="successMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div id="errorAlert" class="alert alert-danger alert-dismissible fade show" style="display: none;">
                <strong>Gagal!</strong> <span id="errorMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <h2><i class="fas fa-calendar-alt"></i> Data Barang</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active">Data Barang</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-2">
                        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#itemModal">
                            <i class="fas fa-plus"></i> Tambah Barang
                        </button>
                        </div>
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch align-items-md-center gap-2 mb-3">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <label class="me-1 me-md-2">Show</label>
                            <select class="form-select form-select-sm me-md-2 w-auto" id="entriesPerPage">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                            <span class="me-md-3">entries</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label class="me-1 me-md-2">Search:</label>
                            <input type="text" class="form-control form-control-sm w-100 w-md-auto" id="searchInput">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Kode Barang</th>
                                    <th>Gambar Barang</th>
                                    <th>Nama Barang</th>
                                    <th>Harga</th>
                                    <th>Stok</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody"> 
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="entriesInfo">Showing 1 to 10 of 10 entries</span>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="modal fade" id="itemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalTitle">
                        <i class="fas fa-plus"></i> Tambah Barang
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="itemForm">
                        <div class="mb-3">
                            <label for="kodeBarang" class="form-label">Kode Barang</label>
                            <input type="text" class="form-control" id="kodeBarang" placeholder="KD01" required>
                        </div>
                        <div class="mb-3">
                            <label for="gambar" class="form-label">Gambar Barang</label>
                            <input type="file" class="form-control" id="gambar" accept="image/*">
                            <div class="mt-2" id="imagePreview" style="display: none;">
                                <img id="previewImg" class="image-preview" src="/placeholder.svg" alt="Preview">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="namaBarang" class="form-label">Nama Barang</label>
                            <input type="text" class="form-control" id="namaBarang" placeholder="Pupuk" required>
                        </div>
                        <div class="mb-3">
                            <label for="harga" class="form-label">Harga</label>
                            <input type="number" class="form-control" id="harga" placeholder="25000" required>
                        </div>
                        <div class="mb-3">
                            <label for="stok" class="form-label">Stok</label>
                            <input type="text" class="form-control" id="stok" placeholder="10" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Reset
                    </button>
                    <button type="button" class="btn btn-warning" id="saveItemBtn">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="scripts.js"></script>
    <script>
        let currentEditId = null;
        let currentPage = 1;
        let entriesPerPage = 10;

        $(document).ready(function() {
            checkAuth();
            loadUserProfile();
            // Fallback checkAuth: jika tidak ada definisinya, gunakan default
            if (typeof window.checkAuth !== "function") {
                window.checkAuth = function() {
                    try {
                        const user = localStorage.getItem("currentUser") || "Admin";
                        $("#currentUser").text(user);
                    } catch {
                        $("#currentUser").text("Admin");
                    }
                };
            }

        /**
         * Loads user profile from localStorage and updates navbar display
         * This keeps the navbar synchronized with profile changes made in profile.html
         */
        function loadUserProfile() {
            // Get user profile data from localStorage
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            
            // Update navbar profile picture if available
            if (profile.profilePicture) {
                $('#navbarProfilePicture').attr('src', profile.profilePicture);
            }
            
            // Update navbar user name with full name
            // Combine first name and last name, or use 'admin' as default
            const fullName = `${profile.firstName || ''} ${profile.lastName || ''}`.trim();
            const displayName = fullName || 'admin';
            $('#currentUser').text(displayName);
        }

            // Pastikan storage valid sebelum render dan event binding
            initializeSampleData();

            // Pasang event listeners lebih awal agar tombol Save bekerja
            $("#saveItemBtn").on("click", saveItem);
            $("#searchInput").on("keyup", filterItems);
            $("#entriesPerPage").on("change", function () {
                entriesPerPage = parseInt($(this).val());
                currentPage = 1;
                loadItems();
            });

            // Preview gambar
            $("#gambar").on("change", async function (e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const dataUrl = await compressImageToDataURL(file, 480, 480, 0.7);
                        $("#previewImg").attr("src", dataUrl);
                        $("#imagePreview").show();
                    } catch (err) {
                        showError('Gagal memproses gambar. Silakan pilih file lain.');
                        $("#imagePreview").hide();
                    }
                } else {
                    $("#imagePreview").hide();
                }
            });

            // Reset form saat modal ditutup dan saat tombol Tambah dibuka
            $("#itemModal").on("hidden.bs.modal", function () {
                resetForm();
            });
            $('[data-bs-target="#itemModal"]').on("click", function () {
                currentEditId = null;
                $("#itemModalTitle").html('<i class="fas fa-plus"></i> Tambah Barang');
                resetForm();
            });

            // Render pertama
            loadItems();
        });

        function loadItems() {
            const items = JSON.parse(localStorage.getItem('items') || '[]');
            const searchTerm = $('#searchInput').val().toLowerCase();
            
            // Filter items
            const filteredItems = items.filter(item => 
                item.kodeBarang.toLowerCase().includes(searchTerm) ||
                item.namaBarang.toLowerCase().includes(searchTerm)
            );

            // Pagination
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / entriesPerPage);
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = startIndex + entriesPerPage;
            const paginatedItems = filteredItems.slice(startIndex, endIndex);

            // Render table
            let html = '';
            paginatedItems.forEach((item, index) => {
                const displayIndex = startIndex + index + 1;
                const imageHtml = item.gambar ? 
                    `<img src="${item.gambar}" class="item-image-thumb me-2" alt="Item Image">` : '';
                
                html += `
                    <tr>
                        <td>${displayIndex}</td>
                        <td>${item.kodeBarang}</td>
                        <td>${imageHtml}</td>
                        <td>${item.namaBarang}</td>
                        <td>Rp. ${formatNumber(item.harga)}</td>
                        <td>${item.stok} Pcs</td>
                        <td>
                            <button class="btn btn-success btn-sm me-1" onclick="editItem(${item.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </td>
                    </tr>
                `;
            });

            $('#itemsTableBody').html(html || '<tr><td colspan="6" class="text-center">No data found</td></tr>');

            // Update pagination
            updatePagination(totalPages);
            
            // Update entries info
            const showingStart = totalItems > 0 ? startIndex + 1 : 0;
            const showingEnd = Math.min(endIndex, totalItems);
            $('#entriesInfo').text(`Showing ${showingStart} to ${showingEnd} of ${totalItems} entries`);
        }

        function updatePagination(totalPages) {
            let paginationHtml = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                paginationHtml += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
            }
            
            $('#pagination').html(paginationHtml);
        }

        function changePage(page) {
            currentPage = page;
            loadItems();
        }

        function filterItems() {
            currentPage = 1;
            loadItems();
        }

        function saveItem() {
            const kodeBarang = $('#kodeBarang').val();
            const namaBarang = $('#namaBarang').val();
            const harga = parseInt($('#harga').val());
            const stok = parseInt($('#stok').val());
            const src = $('#previewImg').attr('src') || '';
            const isPlaceholder = src.includes('/placeholder.svg');
            const gambar = !isPlaceholder ? src : '';

            if (!kodeBarang || !namaBarang || !harga || !stok) {
                alert('Please fill all required fields');
                return;
            }

            const items = JSON.parse(localStorage.getItem('items') || '[]');

            if (currentEditId) {
                const index = items.findIndex((item) => item.id === currentEditId);
                if (index !== -1) {
                    items[index] = { ...items[index], kodeBarang, namaBarang, harga, stok, gambar };
                }
                showSuccess('Data barang berhasil diperbarui');
            } else {
                const nextIdBase = items.length > 0 ? Math.max(...items.map((item) => Number(item?.id) || 0)) : 0;
                const newId = nextIdBase + 1;
                items.push({ id: newId, kodeBarang, namaBarang, harga, stok, gambar });
                showSuccess('Data barang berhasil ditambahkan');
            }

            try {
                localStorage.setItem('items', JSON.stringify(items));
                loadItems();
                bootstrap.Modal.getOrCreateInstance($('#itemModal')[0]).hide();
            } catch (err) {
                // kemungkinan besar QuotaExceededError karena gambar terlalu besar
                showError('Gagal menyimpan data. Ukuran gambar terlalu besar. Silakan pilih gambar yang lebih kecil.');
            }
        }

        function editItem(id) {
            const items = JSON.parse(localStorage.getItem('items') || '[]');
            const item = items.find(item => item.id === id);
            
            if (item) {
                currentEditId = id;
                $('#itemModalTitle').html('<i class="fas fa-edit"></i> Edit Barang');
                $('#kodeBarang').val(item.kodeBarang);
                $('#namaBarang').val(item.namaBarang);
                $('#harga').val(item.harga);
                $('#stok').val(item.stok);
                
                if (item.gambar) {
                    $('#previewImg').attr('src', item.gambar);
                    $('#imagePreview').show();
                }
                
                const modal = bootstrap.Modal.getOrCreateInstance($('#itemModal')[0]);
                modal.show();
            }
        }

        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                const items = JSON.parse(localStorage.getItem('items') || '[]');
                const updatedItems = items.filter(item => item.id !== id);
                localStorage.setItem('items', JSON.stringify(updatedItems));
                loadItems();
                showSuccess('Data barang berhasil dihapus');
            }
        }

        function resetForm() {
            currentEditId = null;
            $('#itemModalTitle').html('<i class="fas fa-plus"></i> Tambah Barang');
            $('#itemForm')[0].reset();
            $('#imagePreview').hide();
        }

        function showSuccess(message) {
            $('#successMessage').text(message);
            $('#successAlert').show().addClass('fade-in');
            setTimeout(() => {
                $('#successAlert').fadeOut();
            }, 3000);
        }

        function showError(message) {
            $('#errorMessage').text(message);
            $('#errorAlert').show();
            setTimeout(() => {
                $('#errorAlert').fadeOut();
            }, 4000);
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function initializeSampleData() {
            try {
                const raw = localStorage.getItem('items');
                if (!raw) {
                    localStorage.setItem('items', JSON.stringify([]));
                    return;
                }
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) {
                    localStorage.setItem('items', JSON.stringify([]));
                }
            } catch {
                localStorage.setItem('items', JSON.stringify([]));
            }
        }

        async function compressImageToDataURL(file, maxW = 480, maxH = 480, quality = 0.7) {
            const dataUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });

            const img = new Image();
            img.onload = () => {
                let { width, height } = img;
                const ratio = Math.min(maxW / width, maxH / height, 1);
                const canvas = document.createElement('canvas');
                canvas.width = Math.round(width * ratio);
                canvas.height = Math.round(height * ratio);
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                // gunakan jpeg agar kompresi efektif
                const out = canvas.toDataURL('image/jpeg', quality);
                resolve(out);
            };
            img.onerror = () => {
                throw new Error('Failed to load image');
            };
            img.src = dataUrl;
            return new Promise((resolve) => {
                img.onload = () => {
                    let { width, height } = img;
                    const ratio = Math.min(maxW / width, maxH / height, 1);
                    const canvas = document.createElement('canvas');
                    canvas.width = Math.round(width * ratio);
                    canvas.height = Math.round(height * ratio);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const out = canvas.toDataURL('image/jpeg', quality);
                    resolve(out);
                };
            });
        }
    </script>
</body>
</html>
